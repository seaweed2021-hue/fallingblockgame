<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Shadow Shift v1.3 — Two-World Platformer</title>
<style>
  :root{--bg:#05060a;--panel:#07121a;--text:#dfeff3}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:18px auto;padding:12px}
  header{display:flex;align-items:center;gap:12px}
  h1{margin:0;font-size:20px}
  .menu{margin-top:12px;background:linear-gradient(180deg,#07121a,#031018);padding:12px;border-radius:10px}
  button{background:#0e2932;color:var(--text);border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  .row{display:flex;gap:10px;align-items:center;margin-top:8px}
  #gameWrap{margin-top:12px;background:linear-gradient(180deg,#031021,#020712);border-radius:10px;padding:10px;position:relative}
  canvas{display:block;width:100%;height:540px;border-radius:6px;background:transparent}
  .hud{position:absolute;left:14px;top:14px;background:rgba(0,0,0,0.35);padding:6px 8px;border-radius:8px;font-size:13px}
  .hudR{position:absolute;right:14px;top:14px;background:rgba(0,0,0,0.35);padding:6px 8px;border-radius:8px;font-size:13px}
  .progressWrap{position:absolute;left:14px;right:14px;bottom:14px;height:12px;background:rgba(0,0,0,0.25);border-radius:10px}
  .progress{height:100%;width:0;background:linear-gradient(90deg,#ffd166,#7dd3fc)}
  .small{font-size:13px;color:#9fb0bb}
  footer{margin-top:8px;font-size:12px;color:#94a8b0;text-align:right}
  .panel{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Shadow Shift v1.3</h1>
    <div class="small" style="margin-left:auto">Swap worlds — Light vs Shadow. Platforms are solid only in their world.</div>
  </header>

  <div class="menu panel">
    <div class="row">
      <button id="playBtn">Play</button>
      <div style="margin-left:8px">
        <label class="small">Level:
          <select id="levelSelect">
            <option value="1">1 — Training</option>
            <option value="2">2 — Mirror Paths</option>
            <option value="3">3 — Labyrinth</option>
          </select>
        </label>
      </div>
      <div style="margin-left:auto" class="row">
        <button id="helpBtn">Help</button>
        <button id="restartBtn">Restart</button>
        <button id="pauseBtn">Pause</button>
      </div>
    </div>
    <div class="row small" style="margin-top:8px">Controls: ← → / A D move • Space / ↑ jump • Shift to swap worlds • P pause • R restart</div>
  </div>

  <div id="gameWrap" class="panel">
    <canvas id="c" width="1280" height="720"></canvas>
    <div class="hud" id="hud">World: LIGHT</div>
    <div class="hudR" id="hudR">Time: 0.00s</div>
    <div class="progressWrap"><div class="progress" id="progress"></div></div>
  </div>

  <footer>Shadow Shift v1.3 — player floatier, coins auto above platforms, parallax background & particles</footer>
</div>

<script>
/* Shadow Shift v1.3 with coins, particles, and parallax background */

const V_W = 1280, V_H = 720;
const GRAV = 0.8;  // lower gravity
const JUMP_V = -16;
const MOVE_SPEED = 5.9;
const LS_BEST = 'ss_v1_best';

const LEVELS = {
  1: {title:'Training', len:2800, backgroundLight:'#e6f6ff', backgroundShadow:'#0b1220',
      platforms:[{x:200,y:520,w:360,h:40,world:'both'},{x:620,y:460,w:160,h:40,world:'light'},{x:820,y:520,w:260,h:40,world:'both'},{x:1180,y:480,w:140,h:40,world:'shadow'},{x:1380,y:520,w:300,h:40,world:'both'},{x:1800,y:520,w:400,h:40,world:'both'},{x:2300,y:480,w:200,h:40,world:'light'},{x:2500,y:520,w:300,h:40,world:'both'}],
      spikes:[{x:560,y:560,w:40,h:40,world:'both'},{x:1540,y:560,w:40,h:40,world:'shadow'}]
  },
  2: {title:'Mirror Paths', len:4200, backgroundLight:'#fffbe6', backgroundShadow:'#070818',
      platforms:[{x:160,y:520,w:240,h:40,world:'both'},{x:420,y:460,w:160,h:40,world:'light'},{x:620,y:600,w:160,h:40,world:'shadow'},{x:880,y:520,w:200,h:40,world:'both'},{x:1160,y:520,w:160,h:40,world:'shadow'},{x:1360,y:460,w:160,h:40,world:'light'},{x:1560,y:520,w:320,h:40,world:'both'},{x:1960,y:480,w:140,h:40,world:'light'},{x:2180,y:520,w:280,h:40,world:'both'},{x:2600,y:520,w:160,h:40,world:'shadow'},{x:2920,y:480,w:500,h:40,world:'both'},{x:3600,y:670,w:600,h:40,world:'both'}],
      spikes:[{x:740,y:560,w:40,h:40,world:'light'},{x:2120,y:560,w:40,h:40,world:'shadow'},{x:2800,y:560,w:40,h:40,world:'both'}]
  },
  3: {title:'Labyrinth', len:6400, backgroundLight:'#fff2f0', backgroundShadow:'#03030a',
      platforms:[{x:200,y:520,w:200,h:40,world:'both'},{x:460,y:520,w:200,h:40,world:'light'},{x:720,y:440,w:160,h:40,world:'shadow'},{x:920,y:520,w:240,h:40,world:'both'},{x:1260,y:520,w:220,h:40,world:'light'},{x:1520,y:460,w:180,h:40,world:'shadow'},{x:1740,y:520,w:300,h:40,world:'both'},{x:2120,y:480,w:160,h:40,world:'light'},{x:2380,y:440,w:160,h:40,world:'shadow'},{x:2680,y:520,w:240,h:40,world:'both'},{x:3040,y:520,w:200,h:40,world:'shadow'},{x:3320,y:460,w:160,h:40,world:'light'},{x:3560,y:520,w:400,h:40,world:'both'},{x:4080,y:520,w:300,h:40,world:'shadow'},{x:4440,y:480,w:160,h:40,world:'light'},{x:4700,y:520,w:170,h:40,world:'both'},{x:5000,y:440,w:260,h:40,world:'shadow'},{x:5360,y:520,w:1040,h:40,world:'both'}],
      spikes:[{x:620,y:560,w:40,h:40,world:'light'},{x:1360,y:560,w:40,h:40,world:'shadow'},{x:2260,y:560,w:40,h:40,world:'both'},{x:3180,y:560,w:40,h:40,world:'light'},{x:4200,y:560,w:40,h:40,world:'shadow'}]
  }
};

const canvas=document.getElementById('c'),ctx=canvas.getContext('2d');
function resize(){ canvas.width=V_W; canvas.height=V_H; }
window.addEventListener('resize',resize); resize();

let curLevel=1, levelObj=LEVELS[curLevel], player=null, camX=0, worldMode='light';
let running=false, paused=false, completed=false, keys={}, jumping=false;
let startTime=0, elapsed=0, best=JSON.parse(localStorage.getItem(LS_BEST)||'{}');

/* ---------- Audio ---------- */
let audioCtx=null,audioReady=false;
function ensureAudio(){ if(audioReady) return; try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); audioReady=true; }catch(e){ audioReady=false; } }
function beep(freq=440,d=0.06,vol=0.04){ if(!audioReady) return; const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+d); }

/* ---------- Player & Level ---------- */
function createPlayerAt(x,y){ return {x:x,y:y,w:40,h:40,vx:0,vy:0,onGround:false}; }
function settlePlayerAtStart(){
  const p=levelObj.platforms.find(pl=>(pl.world==='both'||pl.world==='light'));
  if(p){ player=createPlayerAt(p.x+Math.max(8,Math.floor((p.w-40)/2)),p.y-40); player.vy=0; player.onGround=true; camX=Math.max(0,player.x-200); return; }
  player=createPlayerAt(160, V_H-120); player.vy=0; player.onGround=false; camX=0;
}

function spawnCoinsAbovePlatforms(){
  levelObj.coins=[];
  for(const p of levelObj.platforms){
    if(p.world==='both'||p.world===worldMode){
      levelObj.coins.push({x:p.x+p.w/2-15,y:p.y-35, collected:false, offset:Math.random()*Math.PI*2});
    }
  }
}

function loadLevel(n){
  curLevel=n;
  levelObj=LEVELS[n] || LEVELS[1];
  levelObj.platforms=JSON.parse(JSON.stringify(levelObj.platforms||[]));
  levelObj.spikes=JSON.parse(JSON.stringify(levelObj.spikes||[]));
  worldMode='light';
  settlePlayerAtStart();
  spawnCoinsAbovePlatforms();
  running=true; paused=false; completed=false;
  startTime=now(); elapsed=0;
  updateHUD(); updateProgress(0);
}

/* ---------- Input ---------- */
window.addEventListener('keydown',(e)=>{
  if(e.code==='ArrowLeft'||e.key==='a'||e.key==='A') keys.left=true;
  if(e.code==='ArrowRight'||e.key==='d'||e.key==='D') keys.right=true;
  if(e.code==='Space'||e.code==='ArrowUp'){ keys.jump=true; jumping=true; e.preventDefault(); }
  if(e.key==='Shift') swapWorld();
  if(e.key==='r'||e.key==='R') restartLevel();
  if(e.key==='p'||e.key==='P') togglePause();
});
window.addEventListener('keyup',(e)=>{
  if(e.code==='ArrowLeft'||e.key==='a'||e.key==='A') keys.left=false;
  if(e.code==='ArrowRight'||e.key==='d'||e.key==='D') keys.right=false;
  if(e.code==='Space'||e.code==='ArrowUp'){ keys.jump=false; jumping=false; }
});
canvas.addEventListener('pointerdown',()=>{ ensureAudio(); if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); beep(660,0.04,0.04); });

/* ---------- Swap & HUD ---------- */
function swapWorld(){ worldMode=(worldMode==='light')?'shadow':'light'; updateHUD(); beep(worldMode==='light'?880:460,0.06,0.05); }
const hud=document.getElementById('hud'), hudR=document.getElementById('hudR'), progressEl=document.getElementById('progress');
function updateHUD(){ hud.textContent=`World: ${worldMode.toUpperCase()} — ${levelObj.title}`; }
function updateProgress(p){ progressEl.style.width=(p*100)+'%'; }

/* ---------- Collisions ---------- */
function aabb(ax,ay,aw,ah,bx,by,bw,bh){ return ax<bx+bw && ax+aw>bx && ay<by+bh && ay+ah>by; }

/* ---------- Particles ---------- */
let particles=[];
function spawnParticle(x,y,type){ particles.push({x,y,vx:(Math.random()-0.5)*2,vy:(Math.random()-1.5)*2,life:30+Math.random()*20,color:type==='coin'?'#ffd166':'#7dd3fc'}); }
function updateParticles(){ for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.08; p.life--; if(p.life<=0) particles.splice(i,1); } }
function drawParticles(){ for(const p of particles){ ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,4,4); } }

/* ---------- Loop ---------- */
let last=now();
function loop(){
  const t=now(), dt=clamp(t-last,0,40); last=t;
  if(running && !paused && !completed){ step(dt/16); elapsed=(now()-startTime)/1000; hudR.textContent=`Time: ${elapsed.toFixed(2)}s`; }
  render();
  requestAnimationFrame(loop);
}

/* ---------- Physics Step ---------- */
function step(delta){
  let mv=0;
  if(keys.left) mv-=1;
  if(keys.right) mv+=1;
  player.x+=mv*MOVE_SPEED*delta;
  if(keys.jump && player.onGround){ player.vy=JUMP_V; player.onGround=false; beep(880,0.03,0.03); spawnParticle(player.x+20,player.y+40,'jump'); }
  player.vy+=GRAV*delta; player.y+=player.vy*delta;

  const targetCam=clamp(player.x-200,0,(levelObj.len||V_W)-V_W+200);
  camX+=(targetCam-camX)*0.2;

  player.onGround=false;
  for(const p of levelObj.platforms){
    const solid=(p.world==='both')||(p.world===worldMode);
    if(!solid) continue;
    if(aabb(player.x,player.y,player.w,player.h,p.x,p.y,p.w,p.h)){
      const prevBottom=player.y-player.vy*delta+player.h;
      if(player.vy>=0 && prevBottom<=p.y+6){ player.y=p.y-player.h; player.vy=0; player.onGround=true; }
      else{ restartLevel(); return; }
    }
  }

  for(const s of levelObj.spikes){
    const active=(s.world==='both')||(s.world===worldMode);
    if(!active) continue;
    if(aabb(player.x,player.y,player.w,player.h,s.x,s.y,s.w,s.h)){ beep(160,0.12,0.07); restartLevel(); return; }
  }

  for(const c of levelObj.coins){
    if(!c.collected && aabb(player.x,player.y,player.w,player.h,c.x,c.y,30,30)){
      c.collected=true; beep(1000,0.05,0.05); spawnParticle(c.x+15,c.y+15,'coin');
    }
  }

  if(player.y>V_H+200){ restartLevel(); return; }
  updateParticles();

  const prog=clamp(player.x/(levelObj.len-40),0,1); updateProgress(prog);
  if(player.x>=(levelObj.len-80)){
    running=false; completed=true;
    const bestTime=best[curLevel]||Infinity;
    if(elapsed<bestTime){ best[curLevel]=elapsed; try{ localStorage.setItem(LS_BEST,JSON.stringify(best)); }catch(e){} }
    beep(1200,0.08,0.06); alert('Level Complete! Time: '+elapsed.toFixed(2)+'s');
  }
}

/* ---------- Render ---------- */
function render(){
  // parallax background
  ctx.fillStyle=(worldMode==='light')?levelObj.backgroundLight:levelObj.backgroundShadow;
  ctx.fillRect(0,0,V_W,V_H);
  for(let i=0;i<6;i++){
    ctx.fillStyle=(worldMode==='light')?`rgba(255,255,255,${0.02*i})`:`rgba(255,255,255,${0.01*i})`;
    ctx.beginPath();
    ctx.arc((i*300 - camX*0.2)%V_W, 100+i*60, 60-i*5, 0, Math.PI*2);
    ctx.fill();
  }

  ctx.save(); ctx.translate(-camX,0);

  // platforms
  for(const p of levelObj.platforms){
    const solid=(p.world==='both')||(p.world===worldMode);
    ctx.fillStyle=solid?'#7dd3fc':'rgba(125,211,252,0.1)';
    ctx.fillRect(p.x,p.y,p.w,p.h);
  }

  // spikes
  for(const s of levelObj.spikes){
    const active=(s.world==='both')||(s.world===worldMode);
    if(!active) continue;
    ctx.fillStyle='#fc7d7d';
    ctx.beginPath();
    ctx.moveTo(s.x,s.y+s.h);
    ctx.lineTo(s.x+s.w/2,s.y);
    ctx.lineTo(s.x+s.w,s.y+s.h);
    ctx.closePath();
    ctx.fill();
  }

  // coins
  for(const c of levelObj.coins){
    if(c.collected) continue;
    const bounce=Math.sin(now()/250 + c.offset)*5;
    ctx.fillStyle='#ffd166';
    ctx.beginPath();
    ctx.arc(c.x+15, c.y+15+bounce,12,0,Math.PI*2);
    ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,0.2)'; ctx.stroke();
  }

  // player
  ctx.fillStyle='#7dd3fc';
  ctx.fillRect(player.x,player.y,player.w,player.h);

  drawParticles();
  ctx.restore();
}

/* ---------- Utils ---------- */
function now(){ return performance.now(); }
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }

/* ---------- Controls ---------- */
function togglePause(){ paused=!paused; document.getElementById('pauseBtn').textContent=paused?'Resume':'Pause'; if(!paused) startTime=now()-elapsed*1000; }
function restartLevel(){ loadLevel(curLevel); }

/* ---------- UI Listeners ---------- */
document.getElementById('playBtn').addEventListener('click',()=>loadLevel(+document.getElementById('levelSelect').value));
document.getElementById('helpBtn').addEventListener('click',()=>alert('Shift to swap worlds. Only platforms in the active world are solid.\nUse ← → to move, Space to jump. P pause • R restart.'));
document.getElementById('restartBtn').addEventListener('click',()=>restartLevel());
document.getElementById('pauseBtn').addEventListener('click',()=>togglePause());
document.getElementById('levelSelect').addEventListener('change',(e)=>loadLevel(+e.target.value));

/* ---------- Boot ---------- */
loadLevel(1);
last=now();
requestAnimationFrame(loop);

/* ---------- Defensive saving ---------- */
window.addEventListener('beforeunload',()=>{ try{ localStorage.setItem(LS_BEST,JSON.stringify(best)); }catch(e){} });
</script>
</body>
</html>
